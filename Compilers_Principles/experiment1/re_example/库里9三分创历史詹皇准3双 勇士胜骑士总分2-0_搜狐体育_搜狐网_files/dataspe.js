define("sjs/matrix/ad/dataspe",["sjs/base/corespe","sjs/data/cookie","sjs/data/json","sjs/matrix/ad/config"],function(corespe,cookie,JSON,config){var CONFIG=config._db;var database={get:function(param,callback){(new data_request(param,callback)).get()},get_turn:function(max_turn){if(!this.turn){var cookie_name=CONFIG.COOKIE_ID_PREFIX+'new_turn';var key=CONFIG.PAGEID||encodeURIComponent(document.location.hostname);var ad_turn=cookie(cookie_name)||"{}";ad_turn=JSON.parse(ad_turn);var turn=ad_turn[key]||parseInt(Math.random()*CONFIG.MAX_TURN+1);this.turn=turn;var new_turn=turn+1;if(new_turn>CONFIG.MAX_TURN)new_turn=1;ad_turn[key]=new_turn;cookie(cookie_name,JSON.stringify(ad_turn),{"path":'/',"expires":1})}if(max_turn)return(this.turn-1)%max_turn+1;else return this.turn}};var data_request=function(beans,callback){this.callback=callback;this.beans=beans;this.data=[]};data_request.prototype={get:function(){var beans=this.beans;if(beans.itemspaceid){var new_beans={};new_beans[beans.itemspaceid]=beans;beans=this.beans=new_beans}for(var pro in beans){var bean=beans[pro];var adsrc=201,cpd_data;if(bean.adsrc)adsrc=parseInt(bean.adsrc);else bean.adsrc=adsrc;bean.itemspaceid=pro;bean.status=-1;if(adsrc>=200){cpd_data=this.get_from_cpds(bean);if(adsrc===200){bean.status=0}}if(adsrc!==200&&!cpd_data){bean.adsrc=13;this.get_from_ads(bean)}this.data.push(bean)}this.check_complete()},get_from_cpds:function(bean){var cur_turn=1,cpd_data=null,pro=bean["itemspaceid"],isloc=false,ad_data=window["AD_DATA"]||{};if(/^\d{4,8}$/.test(pro)){if(!bean["turn"]){bean["turn"]=database.get_turn(bean["max_turn"]||1)}cur_turn=bean["turn"]-1;cpd_data=ad_data[pro]&&ad_data[pro][cur_turn]&&ad_data[pro][cur_turn]["data"]||{};isloc=ad_data[pro]&&ad_data[pro][cur_turn]&&ad_data[pro][cur_turn]["isloc"];cpd_data=(isloc&&(CONFIG.IP||CONFIG.SOIP))?(cpd_data[CONFIG.IP]||cpd_data[CONFIG.SOIP.substr(0,6)]||cpd_data[CONFIG.SOIP.substr(0,4)]||cpd_data["DEFAULT"]):cpd_data["DEFAULT"];if(cpd_data){bean.adtype=6;bean.status=0;corespe.extend(bean,cpd_data);return cpd_data}}},get_from_ads:function(param){var self=this;var query=param.query||{};if(!param.itemspaceid||((!param.width||!param.height)&&!param.adps)){return param.status=0}query.itemspaceid=param.itemspaceid;if(!param.adps){var a=(param.height+"").length;param.adps=query.adps=param.width+(1<<(a>=4?0:4-a)).toString(2).substr(1)+param.height}if(!query.adps)query.adps=param["adps"];if(!query.adsrc)query.adsrc=param["adsrc"];if(!query.turn)query.turn=param["turn"]||database.get_turn(param["max_turn"]);if(CONFIG.TAG)query.ic=CONFIG.TAG;query.sf=corespe.sflash();query.pgid=CONFIG.PAGEVIEWID;query.newschn=window.CONFIG?window.CONFIG.CHANNELID:CONFIG.CHANNELID;if(window.multichn){query.multichn=window.multichn}else if(window.CONFIG&&window.CONFIG.PAGEID=="news-article"){if(window.CONFIG.CHANNELID!="1000800000")query.multichn=window.CONFIG.CHANNELID.substr(0,5)+"00000,"+window.CONFIG.CHANNELID;else query.multichn=window.CONFIG.CHANNELID}else if(window.CONFIG&&window.CONFIG.PAGEID.split("-")[1]=='article'&&window.CONFIG.PAGEID!="news-article"){query.multichn=window.CONFIG.CHANNELID.substr(0,5)+"00000"}if(param.needad&&param.needad.length){query.needad=param.needad.length}param.start_time=(new Date).getTime();corespe.jsonpspe({url:CONFIG.URL_ADSERVER,timeout:CONFIG.DEFAULT_TIMEOUT,data:query,complete:function(XMLHttpRequest,textStatus){self.complete(param)},success:function(data,textStatus){self.success(data,param)}})},complete:function(bean){bean.status=0;this.check_complete();},success:function(data,bean){if(data){for(var i=0;i<data.length;i++){data[i].by_server='1';data[i].end_time=(new Date).getTime();if(bean.needad&&bean.needad.length){data[i].itemspaceid=bean.needad[i]}data[0].form=bean.form;corespe.extend(bean,data[i])}}if(bean.end_time){bean.latency=bean.end_time-bean.start_time;}},check_complete:function(){var beans=this.beans;for(pro in beans){if(beans[pro].status===-1)return}this.callback.call(this,this.data)}};return database});